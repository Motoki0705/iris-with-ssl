# M-01 — Auto MPG KNN 回帰パイプライン実装（Level 3）

## 1. 背景と狙い
- No4 演習課題（`resouce/No4演習課題.md`）の S4 セクションでは、Auto MPG データを用いた KNN 回帰の構築と比較検証が求められている。
- F 系チケットで整備した `core.datasets`, `core.features`, `core.metrics` を活用し、後続の線形モデル比較や可視化タスクの土台となる再利用可能な回帰ユーティリティを提供する。
- 実装は `.venv-wsl` 環境を前提とし、`uv run --active ...` コマンドで再現可能なモジュール/API を整備する。

## 2. スコープ
- `src/ml/auto_mpg/knn_regressor.py`
  - `build_knn_regressor(k: int, feature_names: Sequence[str]) -> KNeighborsRegressor` を実装し、スケーリングや前処理（例: `core.features.Standardizer`）を組み合わせた `Pipeline` を返す。
  - `evaluate_knn_models(frame: pd.DataFrame, feature_sets: Sequence[Sequence[str]], k_values: Sequence[int], target: str = "mpg") -> list[dict[str, Any]]` を実装し、学習/検証分割（ホールドアウトまたは KFold）と MSE/R2 計算を実施。
  - すべての関数・モジュールに Google スタイル docstring と型ヒントを付与する。
- `tests/auto_mpg/test_knn_regressor.py`
  - 上記 API のスモークテスト、指標算出、結果件数チェックを記述。
- 参考図や結果テーブルを `docs/results/M-01.md` へまとめる。

## 3. 完了条件（チェックリスト）
- [ ] `build_knn_regressor` と `evaluate_knn_models` が実装され、`evaluate_knn_models` が入力されたすべての `(feature_set, k)` 組み合わせを評価する。
- [ ] `.venv-wsl` をアクティベートして `uv run --active pytest tests/auto_mpg/test_knn_regressor.py` を実行し、結果を `docs/trace/M-01.md` に記録。
- [ ] 最低 3 モデル以上（例: feature_set × k）の評価結果を Markdown 表で `docs/results/M-01.md` にまとめ、再現手順・主要ハイパーパラメータを記載。
- [ ] 生成物・ログの保存先をチケット本文と `docs/tickets/overview.md` に追記し、レビュー待ち状態を明示する。

## 4. 作業ガイド
- データは `core.datasets.load_auto_mpg()` を想定。欠損処理やスケーリングが必要な場合は `core.features` のユーティリティを再利用する。
- 評価指標には `core.metrics.regression_summary`（または同等関数）を活用し、結果を辞書形式で返す。
- コマンド実行時は `source .venv-wsl/bin/activate && uv run --active ...` を徹底し、使用コマンドを `docs/trace/M-01.md` に逐一記録する。
- テストではデータセットを小規模サンプルにカットするなどして実行時間を抑える。

## 5. 依存関係と参照資料
- 依存: F-02 完了（コアユーティリティ利用可能）
- 参照: `docs/spec/requrements.md`（No4 要件）, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/spec/agents.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- 成果物を `docs/results/M-01.md`, `docs/trace/M-01.md` へ保存し、M-02 以降が転用できる API 仕様をチケットに記載する。
- judge へ回す際は評価結果と実行コマンドを overview メモ欄にリンクする。

## 7. 期待成果物
- コード: `src/ml/auto_mpg/knn_regressor.py`
- テスト: `tests/auto_mpg/test_knn_regressor.py`
- ドキュメント: `docs/results/M-01.md`
- トレース: `docs/trace/M-01.md`

## 8. 実施結果（2025-10-14 coder）
- コード/テスト: `build_knn_regressor` と `evaluate_knn_models` を実装し、4 通りの `(feature_set, k)` を評価。`uv run --active pytest tests/auto_mpg` で 9 件のテストに合格。
- 成果物: 指標サマリーは `docs/results/M-01.md`、実行ログは `docs/trace/M-01.md` を参照。
- 次工程: M-02/M-03 と連携するため、同一分割・乱数シードを維持して結果を共有済み。レビュー待ち。
