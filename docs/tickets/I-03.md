# I-03 — Iris K-means クラスタリング実装（Level 2）

## 1. 背景と狙い
- No3 課題 S3 では k=3/4/5 のクラスタリングと 2 特徴ペアによる比較が求められる。
- KNN 実験と同様に再利用可能な API を `iris/kmeans.py` に整備し、クラスタリング結果と可視化を一貫して生成できるようにする。

## 2. スコープ
- `src/ml/iris/kmeans.py`
  - `KMeansConfig` dataclass（features: Sequence[str], n_clusters: int, scaler: str | None, random_state: int, n_init: int）。
  - `run_clustering(config: KMeansConfig) -> tuple[pd.DataFrame, KMeans]` を実装し、特徴量の標準化（任意）と scikit-learn `KMeans` フィットを実現。
  - `evaluate_clustering(model: KMeans, frame: pd.DataFrame, labels: Iterable[str]) -> dict[str, float]` を実装し、`inertia`, `silhouette_score`, `adjusted_rand_score` を算出。
  - `plot_clusters(frame, config, assignments, style_map, ticket_id) -> Path` を実装し、`docs/results/figures/<ticket_id>_k<clusters>_<x>_<y>.png` に保存。
  - `compare_feature_pairs(configs: Sequence[KMeansConfig], ticket_id: str) -> list[dict[str, Any]]` を実装し、各設定の指標と図パスをまとめる。
- クラスタリングの評価表と考察を `docs/results/I-03.md` に記載。

## 3. 完了条件（チェックリスト）
- [ ] 上記関数・dataclass の実装（Google スタイル docstring・型ヒント付与）。
- [ ] `tests/iris/test_kmeans.py` を追加し、以下を確認:
  - `run_clustering` が `n_clusters` 個のラベルを生成する。
  - `evaluate_clustering` の指標が 0〜1 範囲（`inertia` を除く）に収まる。
  - `plot_clusters` がファイルを保存し Path を返却する。
- [ ] `.venv-wsl` 環境で `uv run --active pytest tests/iris/test_kmeans.py` を実行し、結果を `docs/trace/I-03.md` に記録。
- [ ] 代表的な図（少なくとも 3 枚）を生成し、`docs/results/figures/I-03_*.png` に保存。`docs/results/I-03.md` にリンクを掲載。

## 4. 作業ガイド
- `labels` 引数は教師データ（species）を受け取り、ARI の比較に利用する。教師無し設定では `None` を許容し、ARA 算出をスキップ。
- `silhouette_score` は 2 特徴ペアでのみ計算可能なため、入力次元が 2 より大きい場合は警告ログを出し `np.nan` を返す。
- 図のスタイルには I-01 の `build_species_style_map` を流用し、クラスタと教師ラベルを双方向に比較できる図にする（色=教師、マーカー=クラスタなど）。
- 実験設定は {k=3,4,5} × {全特徴, sepal ペア, petal ペア} を最低限含める。

## 5. 依存関係と参照資料
- 依存: I-01, I-02
- 参照: `docs/spec/requrements.md`（No3 S3 の要件）, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/tickets/I-02.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- 完了後に `docs/results/I-03.md`, `docs/trace/I-03.md` で結果を共有し、I-04 が呼び出す API（特に `compare_feature_pairs`）の使用例を記載する。
- judge レビュー向けに図表と指標を整理し、`docs/judges/I-06.md` で参照できるようチケット内にリンクを残す。

## 7. 期待成果物
- コード: `src/ml/iris/kmeans.py`, `tests/iris/test_kmeans.py`
- ドキュメント: `docs/results/I-03.md`
- トレース: `docs/trace/I-03.md`
- 図表: `docs/results/figures/I-03_*.png`
