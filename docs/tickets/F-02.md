# F-02 — コアユーティリティ初期実装（Level 1）

## 1. 背景と狙い
- F-01 で整えた `src/ml` 骨組みを実際のデータ処理に耐える形へ拡張する初期実装タスク。
- Iris / Auto MPG / SSL すべての後続チケットが依存する共通ユーティリティを確立し、データロードや特徴変換、評価指標、成果物保存の基礎を固める。

## 2. スコープ
- `src/ml/core/datasets.py`
  - `load_iris_dataset()` / `load_auto_mpg_dataset()` で `data/` 配下 CSV を読み込み、`pandas.DataFrame` を返す。
  - 共通関数 `train_test_split_frame()` を実装し、`sklearn.model_selection.train_test_split` をラップ。`test_size`, `random_state`, `stratify` を引数化。
  - `DATA_ROOT` を `Path` で解決し、存在チェック・例外ハンドリングを追加。
- `src/ml/core/features.py`
  - `build_scaler(transform: str)` で `"standard"`, `"minmax"` を切替可能なスケーラーファクトリを提供。
  - `PolynomialFeatureConfig` dataclass（degree, include_bias, interaction_only）と `build_polynomial_features()` を実装。
  - iris/auto_mpg 用のカラムスキーマ（dict）を定義し、`select_columns(frame, schema_key)` で抽出できるようにする。
- `src/ml/core/metrics.py`
  - 分類用 `ClassificationReport`（accuracy, precision, recall, f1）と回帰用 `RegressionReport`（mse, mae, r2）を dataclass として定義。
  - `evaluate_classification(y_true, y_pred)` および `evaluate_regression(y_true, y_pred)` を実装し、`np.ndarray | pd.Series` を受け付ける。
- `src/ml/core/visualization.py`
  - `save_fig(fig, path)` を実装し、`docs/results/figures/` への保存とパス返却を行う。
  - `scatter_plot()`（分類向け）と `residual_plot()`（回帰向け）のベースライン関数を定義し、色・凡例・タイトルを引数化。
- `src/ml/core/logging.py`
  - `ResultArtifact` dataclass（ticket_id, artifact_path, description, created_at）を定義。
  - `write_result_markdown(ticket_id, summary, artifacts)` で `docs/results/<ticket_id>.md` へ追記、`write_trace(ticket_id, content)` で `docs/trace/<ticket_id>.md` へ追記するヘルパーを実装。
  - 出力先ディレクトリが無い場合は作成する。
- 既存ファイルの docstring を保持しつつ、Google スタイル docstring をすべての新規関数・クラスに付与する。

## 3. 完了条件（チェックリスト）
- [ ] 上記関数・dataclass を実装し、型ヒントと Google スタイル docstring を付与する。
- [ ] `data/iris.csv`, `data/auto_mpg.csv` が存在しない場合に適切な `FileNotFoundError` を発生させるテストを作成。
- [ ] `tests/test_core_datasets.py`, `tests/test_core_metrics.py` を追加し、主要関数のスモークテストを実行する。
- [ ] `.venv-wsl` をアクティベートした状態で `uv run --active pytest` が緑化することを確認し、`docs/trace/F-02.md` にコマンドと結果を記録する。
- [ ] 実装内容と出力先のまとめを `docs/results/F-02.md` に記載する。

## 4. 作業ガイド
- コマンドは `source .venv-wsl/bin/activate && uv run --active ...` 形式で実行する。
- Pandas, scikit-learn, NumPy のインポートは既存依存関係のみを利用し、新規パッケージ追加が必要な場合は planner に相談する。
- 結果出力先のパスは `docs/spec/directory-structure.md` に準拠させ、関数内でのパス文字列は `Path` オブジェクトで管理する。
- テストは pytest ベースとし、`tests/__init__.py` を作成してパッケージとして扱う。

## 5. 依存関係と参照資料
- 依存: F-01 完了
- 参照: `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/spec/requrements.md`, `AGENTS.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- 作業完了後に `docs/results/F-02.md`, `docs/trace/F-02.md` のリンクを本チケットと overview に追記する。
- tester は次フェーズ（F-04）でテスト体系を拡張するため、使い方を `docs/results/F-02.md` へ簡潔にまとめること。

## 7. 期待成果物
- コード: `src/ml/core/*.py` の実装更新、`tests/test_core_*.py`
- ドキュメント: `docs/results/F-02.md`
- トレース: `docs/trace/F-02.md`
