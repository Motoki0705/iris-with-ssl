# M-03 — Auto MPG 回帰モデル比較レポート生成（Level 3）

## 1. 背景と狙い
- No4 演習課題の Discussion では、複数モデル（KNN・線形・多項式など）を対象に MSE / R2 を比較し、最適な構成を議論することが求められる。
- M-01 / M-02 で取得した評価結果を統合し、後続の可視化・ワークフロー（M-04 / M-05 / M-06）が利用できる標準化されたレポートとランキングを生成する。
- 再実行可能なスクリプトと記録テンプレートを整備し、`.venv-wsl` + `uv run --active ...` で検証できる状態を目指す。

## 2. スコープ
- `src/ml/auto_mpg/comparison.py`
  - `compile_regression_results(knn_results: Sequence[dict[str, Any]], linear_results: Sequence[dict[str, Any]]) -> pd.DataFrame` を実装し、共通列（モデル名、特徴、k/degree、MSE、R2 など）を整形。
  - `rank_models(results: pd.DataFrame, top_n: int = 3) -> dict[str, pd.DataFrame]` を実装し、MSE 下位・R2 上位のトップ N モデルを抽出。
  - `generate_discussion_report(results: pd.DataFrame, output_path: Path | str) -> Path` を実装し、Markdown テンプレートで考察の骨子と表を出力。
  - すべての関数に Google スタイル docstring と型ヒントを付与。
- `tests/auto_mpg/test_comparison.py`
  - 入力ダミーデータから期待する列構造・ランキング件数・Markdown 出力の存在を検証。
- レポート下書きを `docs/results/M-03.md` として保存。

## 3. 完了条件（チェックリスト）
- [ ] 比較モジュール各関数が実装され、少なくとも MSE・R2 の両指標を正しく処理する。
- [ ] `.venv-wsl` をアクティベートし `uv run --active pytest tests/auto_mpg/test_comparison.py` を実行、結果を `docs/trace/M-03.md` に記録。
- [ ] `docs/results/M-03.md` に生成された表（トップ3モデルの例）と考察メモを追記し、`generate_discussion_report` で出力される Markdown ファイルへのリンクを掲載。
- [ ] チケットと `docs/tickets/overview.md` に成果物パス、テスト状況、レビュー待ち状態を反映。

## 4. 作業ガイド
- M-01/M-02 の結果を読み込む際は JSON/CSV/Dict など汎用フォーマットに対応させ、再実行時の互換性を確保。
- Markdown レポートには日時・使用データセット・主要設定を冒頭に記載し、judge が差分レビューしやすい構造にする。
- 結果 DataFrame には `model_type`, `parameters`, `features`, `metrics` などの列を揃え、後続の可視化用 ID を保持。
- コマンド記録は `docs/trace/M-03.md` にまとめ、生成したレポートファイルパスも記録する。

## 5. 依存関係と参照資料
- 依存: M-01, M-02
- 参照: `docs/spec/requrements.md`（Discussion 要件）, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/spec/agents.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- `docs/results/M-03.md`, `docs/trace/M-03.md` に結果とログを保存し、M-04 で利用する列・パス・ファイル命名規則を明記。
- judge レビューに向けて、トップモデルの根拠や考察メモを簡潔にまとめる。

## 7. 期待成果物
- コード: `src/ml/auto_mpg/comparison.py`
- テスト: `tests/auto_mpg/test_comparison.py`
- ドキュメント: `docs/results/M-03.md`, `docs/results/discussion/M-03_report.md`（`generate_discussion_report` 出力例）
- トレース: `docs/trace/M-03.md`

## 8. 実施結果（2025-10-14 coder）
- コード/テスト: 比較 DataFrame、ランキング、Markdown 生成ユーティリティを実装。`uv run --active pytest tests/auto_mpg` で比較モジュールを含む 9 件のテストが成功。
- 成果物: `docs/results/M-03.md` に要約、`docs/results/discussion/M-03_report.md` にトップ3モデル表を出力。`tabulate` 非依存のテキスト表で環境差を吸収。
- トレース: 実行ログは `docs/trace/M-03.md`。M-04 以降で利用できる列構造を確認済み。レビュー待ち。
