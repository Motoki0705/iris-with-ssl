# M-02 — Auto MPG 線形・多項式回帰ユーティリティ実装（Level 3）

## 1. 背景と狙い
- No4 演習課題の線形回帰パートでは、単回帰/多項式回帰および複数特徴を用いたモデルの比較と可視化が求められる。
- M-01 の KNN 評価結果と整合する指標を算出し、後続の比較・可視化チケット（M-03/M-04）で再利用できる API を提供する。
- `.venv-wsl` を前提に `uv run --active ...` コマンドで再現できる構成を整備する。

## 2. スコープ
- `src/ml/auto_mpg/linear_models.py`
  - `build_linear_regressor(feature_names: Sequence[str], include_bias: bool = True) -> Pipeline` を実装。
  - `build_polynomial_regressor(feature_names: Sequence[str], degree: int = 2) -> Pipeline` を実装し、前処理＋`PolynomialFeatures`＋回帰器を返す。
  - `evaluate_linear_models(frame: pd.DataFrame, configs: Sequence[dict[str, Any]], target: str = "mpg") -> list[dict[str, Any]]` を実装し、MSE/R2/MAE などを算出して辞書として返却。
  - すべての関数に Google スタイル docstring と型ヒントを付与。
- `tests/auto_mpg/test_linear_models.py`
  - 各ビルダー関数の戻り値が `Pipeline` であること、`evaluate_linear_models` が設定数分の結果を返すことをテスト。
- 結果サマリを `docs/results/M-02.md` にまとめる。

## 3. 完了条件（チェックリスト）
- [ ] 線形/多項式回帰のビルダー関数が実装され、指定した特徴数と次数で学習できる。
- [ ] `evaluate_linear_models` が少なくとも 3 つの構成を評価し、MSE と R2 を含む指標を返す。
- [ ] `.venv-wsl` をアクティベートした状態で `uv run --active pytest tests/auto_mpg/test_linear_models.py` を実行し、結果を `docs/trace/M-02.md` に記録。
- [ ] `docs/results/M-02.md` に実験手順、ハイパーパラメータ、主要指標を表形式で掲載し、M-03 へ渡す比較観点を明記。

## 4. 作業ガイド
- `core.datasets.load_auto_mpg()` と `core.features` のトランスフォーマを活用し、前処理を共通化する。
- 多項式回帰では過学習を避けるため正則化（例: Ridge）も設定できる構成を検討し、設定の有無を記録する。
- 可能であれば `plot_predictions_vs_actual` などの補助関数を下書きし、M-04 で再利用できるよう TODO コメントを残す。
- すべてのコマンドは `source .venv-wsl/bin/activate && uv run --active ...` 形式で実行し、コマンド履歴を `docs/trace/M-02.md` に添付。

## 5. 依存関係と参照資料
- 依存: M-01（データ分割・評価指標の整合性を共有）
- 参照: `docs/spec/requrements.md`（No4 要件）, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/spec/agents.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- 評価結果・コード変更を `docs/results/M-02.md`, `docs/trace/M-02.md` に保存し、M-03/M-04 で利用できるパラメータ名をチケット本文に明記。
- judge への引き継ぎ時は結果ファイルのパスおよび実行コマンドを `docs/tickets/overview.md` のメモ欄に追記。

## 7. 期待成果物
- コード: `src/ml/auto_mpg/linear_models.py`
- テスト: `tests/auto_mpg/test_linear_models.py`
- ドキュメント: `docs/results/M-02.md`
- トレース: `docs/trace/M-02.md`

## 8. 実施結果（2025-10-14 coder）
- コード/テスト: 線形・多項式ビルダーと `evaluate_linear_models` を実装。`uv run --active pytest tests/auto_mpg` でユニットテスト完了。
- 指標集計: `linear_hp`, `linear_hp_wt`, `poly_hp_deg2` を評価し、`docs/results/M-02.md` に表形式で掲載。
- トレース: コマンドログは `docs/trace/M-02.md`。M-03 で利用するためパラメータ記録を明示化済み。レビュー待ち。
