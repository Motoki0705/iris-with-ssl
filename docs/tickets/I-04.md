# I-04 — Iris 実験オーケストレーション実装（Level 2）

## 1. 背景と狙い
- No3 課題の成果を体系的に再現できるよう、KNN/K-means の設定を一括で実行し成果物を自動生成する実験ハーネスが必要。
- notebooks や CLI から呼び出せるよう `iris/experiments.py` に共通インターフェースを実装し、ログと図表を統合管理する。

## 2. スコープ
- `src/ml/iris/experiments.py`
  - `IrisExperimentReport` dataclass（ticket_id: str, knn_results: list[dict[str, Any]], kmeans_results: list[dict[str, Any]], generated_artifacts: list[Path]）。
  - `build_default_knn_configs()` / `build_default_kmeans_configs()` を実装し、I-02/I-03 要件を満たす設定リストを返す。
  - `run_knn_suite(configs: Sequence[KnnConfig], ticket_id: str) -> list[dict[str, Any]]` を実装し、I-02 の API を呼び出して結果を集約。
  - `run_kmeans_suite(configs: Sequence[KMeansConfig], ticket_id: str) -> list[dict[str, Any]]` を実装。
  - `generate_report(ticket_id: str, output_dir: Path | None = None) -> IrisExperimentReport` を実装し、上記スイートを実行して `docs/results/<ticket_id>.md` を更新、`core.logging.write_trace` でログを残す。
  - `main(args: Namespace | None = None)` を実装し、`--ticket-id`, `--knn-only`, `--kmeans-only` などの CLI 引数を受け付けられるよう argparse を利用。
- 実験結果を `docs/results/I-04.md` にまとめ、各図表・指標へのリンクを添付。

## 3. 完了条件（チェックリスト）
- [ ] 上記関数・dataclass の実装（Google スタイル docstring・型ヒント付与）。
- [ ] `uv run --active python -m ml.iris.experiments --ticket-id I-04` を実行し、生成された成果物とログを `docs/trace/I-04.md` に記録。
- [ ] `tests/iris/test_experiments.py` を追加し、以下を検証:
  - `build_default_knn_configs` / `build_default_kmeans_configs` が期待数の設定（少なくとも 4 件ずつ）を返す。
  - `generate_report` が `IrisExperimentReport` を返し、`generated_artifacts` が空でない。
  - CLI エントリポイントが `--knn-only` / `--kmeans-only` でエラー無く実行できる（pytest では `capsys` や `monkeypatch` を利用して短縮実行）。
- [ ] `docs/results/I-04.md` に総括サマリ（最良モデル、比較表、考察メモ）を記載。

## 4. 作業ガイド
- `run_knn_suite` / `run_kmeans_suite` では各設定から返る dict に `artifact_paths`（図・表）を追記し、`generate_report` で一意に管理する。
- `core.logging.write_result_markdown` と `write_trace` を活用し、再現手順や CLI コマンドを自動追記する。
- CLI 実行時の制約を考慮し、`--max-runs` や `--no-plot` オプションを設ける場合はデフォルトで全実験を実施する仕様に合わせる。
- 実験に時間がかかる場合は `tqdm` など外部依存を追加せず、簡潔なログ出力（print or logging）で進捗を示す。

## 5. 依存関係と参照資料
- 依存: I-02, I-03
- 参照: `docs/spec/requrements.md`, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/tickets/I-02.md`, `docs/tickets/I-03.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- 完了後、`docs/results/I-04.md`, `docs/trace/I-04.md` を overview に追記し、I-05 のテスト設計に必要な出力ファイル一覧を明記。
- judge レビューを想定し、生成された成果物を `docs/judges/I-06.md` から参照できるよう表形式でまとめる。

## 7. 期待成果物
- コード: `src/ml/iris/experiments.py`, `tests/iris/test_experiments.py`
- ドキュメント: `docs/results/I-04.md`
- トレース: `docs/trace/I-04.md`
- 生成ファイル: `docs/results/figures/I-0[1234]_*.png`, 指標 CSV 等
