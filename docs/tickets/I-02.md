# I-02 — Iris KNN 分類パイプライン実装（Level 2）

## 1. 背景と狙い
- No3 課題 S2 では Iris の 4 特徴を用いた KNN 分類に加え、k の変更と 2 特徴ペアごとの比較が求められる。
- I-01 で整備した可視化ユーティリティを活用し、`iris/knn_classifier.py` を汎用的な学習・評価・描画モジュールとして実装する。

## 2. スコープ
- `src/ml/iris/knn_classifier.py`
  - `KnnConfig` dataclass（features: Sequence[str], k: int, scaler: str, test_size: float, random_state: int）。
  - `prepare_dataset(config: KnnConfig) -> tuple[pd.DataFrame, pd.Series, pd.DataFrame, pd.Series]` を実装し、`core.datasets.load_iris_dataset()` と `core.features.build_scaler()` を活用。
  - `train_classifier(config: KnnConfig) -> KNeighborsClassifier` を実装し、scikit-learn の `KNeighborsClassifier` をフィット。
  - `evaluate_classifier(model, x_test, y_test) -> core.metrics.ClassificationReport` を実装。
  - `plot_decision_boundary(model, frame, config, style_map, ticket_id, grid_resolution=200)` を実装し、`core.visualization.scatter_plot` と I-01 の `scatter_feature_pair` を組み合わせて描画。保存先は `docs/results/figures/<ticket_id>_knn_k<k>_<x>_<y>.png`。
  - 1 vs rest の混同行列を生成する `compute_confusion_matrix(...) -> pd.DataFrame` を実装。
- 4 特徴全体と 2 特徴ペア（sepal, petal）の実験結果を `docs/results/I-02.md` にまとめ、指標/混同行列/図へのリンクを記載。

## 3. 完了条件（チェックリスト）
- [ ] 上記関数および dataclass を実装し、Google スタイル docstring と型ヒントを付与。
- [ ] `run_knn_experiments(configs: Sequence[KnnConfig], ticket_id: str) -> list[dict[str, Any]]` を実装し、複数設定の結果をリストで返却。
- [ ] `tests/iris/test_knn_classifier.py` を追加し、以下を検証:
  - `prepare_dataset` の分割サイズが `config.test_size` に従う。
  - `train_classifier` が `KNeighborsClassifier` を返し、予測精度が 0.8 以上である。
  - `compute_confusion_matrix` が 3x3 行列を返し、対角要素が正の数である。
- [ ] `.venv-wsl` 環境で `uv run --active pytest tests/iris/test_knn_classifier.py` を実行し、結果を `docs/trace/I-02.md` に記録。
- [ ] 代表的な決定境界図を 2 枚以上保存し、パスを `docs/results/I-02.md` に記載。

## 4. 作業ガイド
- スケーリングは `config.scaler` に `"standard"` または `"minmax"` を受け付けるよう実装し、不正値は ValueError を発生させる。
- 決定境界は 2 特徴ペアでのみ描画し、4 特徴の場合は混同行列と指標のみ記録する。
- wandb 等の外部サービスは使用せず、ログは `core.logging.write_result_markdown` を活用。
- K 値は {1, 3, 5, 10} を想定し、`run_knn_experiments` の戻り値に `config`, `metrics`, `confusion_matrix_path`, `figure_path` を含める。

## 5. 依存関係と参照資料
- 依存: F-02, I-01
- 参照: `docs/spec/requrements.md`（No3 S2 の要件）, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/tickets/I-01.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- 完了後に `docs/results/I-02.md`, `docs/trace/I-02.md`, `docs/results/figures/I-02_*.png` を overview メモへ追加し、I-03 実装に必要な API（特にスタイル・データ準備関数）を共有する。
- judge レビュー向けに混同行列 CSV / 図の参照先を明記する。

## 7. 期待成果物
- コード: `src/ml/iris/knn_classifier.py`, `tests/iris/test_knn_classifier.py`
- ドキュメント: `docs/results/I-02.md`
- トレース: `docs/trace/I-02.md`
- 図表: `docs/results/figures/I-02_*.png`
