# I-05 — Iris ワークフローテスト実装（Level 2）

## 1. 背景と狙い
- I-02 〜 I-04 の実装が揃った段階で、データロードから可視化・指標算出までのワークフローを検証する回帰テストが必要。
- テスター視点で再現性と回帰検出を担保するため、pytest ベースのシナリオテストを整備する。

## 2. スコープ
- `tests/iris/conftest.py`
  - `iris_style_map` フィクスチャ: I-01 `build_species_style_map` を呼び出してスタイルを準備。
  - `iris_knn_configs` フィクスチャ: I-04 `build_default_knn_configs` を参照し、短時間で動作する 2 設定に絞ったリストを返す。
  - `iris_kmeans_configs` フィクスチャ: 同様に 2 設定を返す。
- `tests/iris/test_workflow.py`
  - `test_knn_workflow_smoke`: `run_knn_suite` を呼び出して結果件数・指標形式を確認、生成物が存在することを検証。
  - `test_kmeans_workflow_smoke`: `run_kmeans_suite` を呼び出して inertia/silhouette の妥当性を確認。
  - `test_generate_report_cli`: `uv run --active python -m ml.iris.experiments --ticket-id TEST-I-05 --knn-only` を `subprocess` で実行し、戻り値 0 と成果物生成を検証（実行時は `tmp_path` を活用して出力先を差し替え）。
- 結果サマリを `docs/results/I-05.md` に記載し、テスト対象・生成ログ・残課題をまとめる。

## 3. 完了条件（チェックリスト）
- [ ] 上記テストファイルとフィクスチャを実装し、Google スタイル docstring を付与。
- [ ] `.venv-wsl` 環境で `uv run --active pytest tests/iris/test_workflow.py` を実行し、成功ログを `docs/trace/I-05.md` に記録。
- [ ] CLI 実行テストで生成された成果物をテスト終了時にクリーンアップ（`tmp_path` 利用）し、リポジトリに不要ファイルが残らないこと。
- [ ] テストで依存する I-02〜I-04 の API が更新された場合に備え、失敗時ログ収集のヒントを `docs/results/I-05.md` に記載。

## 4. 作業ガイド
- pytest 実行時間は 60 秒以内を目安にし、必要であれば設定数やデータサイズを最小限に抑える。
- CLI テスト時は `subprocess.run([...], check=True)` を使用し、`env` で `PYTHONPATH` を適切に設定（`src` 参照）する。
- `docs/trace/I-05.md` には使用したコマンド、テスト個数、所要時間を記録する。
- テスト実行後に `docs/results/` 直下へ成果物が残った場合は `tmp_path` を使って削除する仕組みを導入。

## 5. 依存関係と参照資料
- 依存: I-01, I-02, I-03, I-04
- 参照: `docs/spec/implementation-tasks.md`, `docs/tickets/I-01.md`, `docs/tickets/I-02.md`, `docs/tickets/I-03.md`, `docs/tickets/I-04.md`

## 6. 想定担当とハンドオフ
- 担当: tester
- 完了後に `docs/results/I-05.md`, `docs/trace/I-05.md` を overview にリンクし、I-06 の judge が参照するポイント（生成物一覧・テスト結果）を明記。
- 再現手順に不確定要素があれば planner にフィードバックし、フォローアップチケットを提案する。

## 7. 期待成果物
- テストコード: `tests/iris/conftest.py`, `tests/iris/test_workflow.py`
- ドキュメント: `docs/results/I-05.md`
- トレース: `docs/trace/I-05.md`
