# M-04 — Auto MPG 回帰可視化ユーティリティ実装（Level 3）

## 1. 背景と狙い
- No4 演習課題では、回帰モデルごとの予測曲線や残差の挙動を可視化し考察することが求められている。
- M-01/M-02/M-03 で得られたモデルと比較結果を視覚化し、Figure を `docs/results/figures/` に保存してレポートへ添付できる状態にする。
- 可視化コードは他タスクでも再利用できる汎用 API とし、`.venv-wsl` で再現可能なコマンドを整備する。

## 2. スコープ
- `src/ml/auto_mpg/visualization.py`
  - `plot_regression_curves(frame: pd.DataFrame, model_configs: Sequence[dict[str, Any]], save_dir: Path | None = None) -> list[Path]` を実装し、実測値と予測曲線を同一グラフに描画。
  - `plot_residuals(results: Sequence[dict[str, Any]], save_dir: Path | None = None) -> list[Path]` を実装し、残差散布図や箱ひげ図を生成。
  - 図保存は `core.visualization.save_fig` を利用し、戻り値としてファイルパスのリストを返す。
  - すべての関数に Google スタイル docstring と型ヒントを付与。
- `tests/auto_mpg/test_visualization.py`
  - ダミーデータで各関数が `Path` のリストを返し、ファイルが生成されることを確認。
- 代表的な図を `docs/results/figures/M-04_*.png` として保存し、概要を `docs/results/M-04.md` にまとめる。

## 3. 完了条件（チェックリスト）
- [ ] 可視化関数が実装され、少なくとも 2 種類以上のプロット（予測曲線・残差）が生成される。
- [ ] `.venv-wsl` をアクティベートして `uv run --active pytest tests/auto_mpg/test_visualization.py` を実行し、結果を `docs/trace/M-04.md` に記録。
- [ ] 生成図を `docs/results/figures/` に保存し、ファイル一覧と考察メモを `docs/results/M-04.md` に掲載。
- [ ] チケット本文と `docs/tickets/overview.md` に成果物パス・テスト状況を追記し、レビュー待ちを示す。

## 4. 作業ガイド
- 可視化は matplotlib/seaborn を利用し、凡例・軸ラベル・タイトルを統一。図幅や DPI を結果文書のレイアウトに合わせる。
- 保存ファイル名は `M-04_<model>_<plot_type>.png` の形式で揃え、M-03 の比較 DataFrame のカラム値を利用して命名する。
- 必要に応じて `plot_predictions_vs_actual` のような補助関数を別途整備し、他モジュールからも読み込める形にする。
- コマンドは `source .venv-wsl/bin/activate && uv run --active ...` 形式で実行し、`docs/trace/M-04.md` に記録する。

## 5. 依存関係と参照資料
- 依存: M-01, M-02, M-03
- 参照: `docs/spec/requrements.md`（No4 可視化要件）, `docs/spec/architecture.md`, `docs/spec/implementation-tasks.md`, `docs/spec/agents.md`

## 6. 想定担当とハンドオフ
- 担当: coder
- `docs/results/M-04.md`, `docs/trace/M-04.md` に成果とログをまとめ、M-05 テストが利用できるサンプル図パスを列挙。
- judge レビュー用に代表図のスクリーンショット（PNG）パスを `docs/tickets/overview.md` のメモ欄に追加。

## 7. 期待成果物
- コード: `src/ml/auto_mpg/visualization.py`
- テスト: `tests/auto_mpg/test_visualization.py`
- ドキュメント: `docs/results/M-04.md`
- 画像: `docs/results/figures/M-04_*.png`
- トレース: `docs/trace/M-04.md`
